name: 同步文件

on:
  schedule:
    # 每天北京时间上午9点执行 (UTC+8)
    - cron: '0 1 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: 设置Git配置
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: 下载并解压文件
      run: |
        echo "开始下载文件..."
        
        # 下载文件（按需替换 URL）
        curl -L -o "data.zip" "https://raw.githubusercontent.com/PizazzGY/NewTVBox/refs/heads/main/%E5%8D%95%E7%BA%BF%E8%B7%AF.zip"
        
        # 检查下载是否成功
        if [ ! -f "data.zip" ]; then
          echo "下载失败"
          exit 1
        fi
        
        echo "下载成功，文件大小: $(ls -lh data.zip | awk '{print $5}')"
        echo "开始解压到临时目录 tmp ..."
        mkdir -p tmp
        unzip -o "data.zip" -d tmp
        echo "解压完成，查找 tvbox 目录..."
        
        # 优先使用预期路径 tmp/TVBoxOSC/tvbox
        if [ -d "tmp/TVBoxOSC/tvbox" ]; then
          echo "找到 tmp/TVBoxOSC/tvbox，复制到仓库根目录..."
          rsync -a tmp/TVBoxOSC/tvbox/ .
        else
          # 若预期路径不存在，则在 tmp 中查找名为 tvbox 的目录
          tvbox_dir=$(find tmp -type d -name tvbox | head -n1 || true)
          if [ -n "$tvbox_dir" ]; then
            echo "找到 tvbox 目录：$tvbox_dir，复制到仓库根目录..."
            rsync -a "$tvbox_dir"/. .
          else
            echo "未找到 tvbox 目录，列出 tmp 内容以供调试:"
            ls -R tmp
            rm -rf tmp data.zip
            exit 1
          fi
        fi

        echo "复制完成，显示仓库根目录预览："
        ls -la
        echo "清理临时文件..."
        rm -rf tmp data.zip
        echo "完成"
    
    - name: 检查更改
      id: check-changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "检测到文件更改"
          echo "has-changes=true" >> $GITHUB_OUTPUT
        else
          echo "没有检测到文件更改"
          echo "has-changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: 提交更改
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        echo "提交更改..."
        git add .
        git commit -m "自动更新 (来自 TVBoxOSC/tvbox): $(date '+%Y-%m-%d %H:%M:%S')"
        git push origin HEAD:main
        echo "更改已提交"
